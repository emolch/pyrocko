<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>Squirrel</title>
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="images/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="images/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="images/favicon-16x16.png"
        />
        <link rel="manifest" href="site.webmanifest" />

        <link href="css/bootstrap.min.css" rel="stylesheet" />
        <link href="css/local.css" rel="stylesheet" />
        <script src="js/d3.v7.min.js"></script>
        <script src="js/bootstrap.bundle.min.js"></script>
    </head>

    <body>
        <div id="app" class="vbox-container">
            <!--{{ selectedTab }}-->
            <div v-if="!connection.connected" class="curtain">DISCONNECTED</div>
            <div v-if="connection.connected && connection.connected.delay > 5.0" class="curtain">DELAY {{ fmtDuration(connection.connected.delay) }}</div>
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link" :class="{ active: selectedTab === 1}" @click="selectTab(1)"><img src="favicon.ico" width="30" height="30"></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" :class="{ active: selectedTab === 2}" @click="selectTab(2)">Timeline</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" :class="{ active: selectedTab === 3}" @click="selectTab(3)">Map</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" :class="{ active: selectedTab === 4}" @click="selectTab(4)">Info</a>
                </li>
            </ul>

                <div v-show="selectedTab === 1" id="add" class="vbox-main tab-pane">
                    <template v-for="res in response">
                        <p>{{res}}</p>
                    </template>
                </div>


                <div v-show="selectedTab === 2" id="timeline" tabindex="0" class="vbox-main tab-pane">
                </div>
                <div class="container" v-show="selectedTab === 2">
                    <div class="form-group row">
                        <div class="col-2">
                            <input type="text" class="form-control" v-model="gates.frequencyMin" />
                        </div>
                        <div class="col-2">
                            <input type="text" class="form-control" v-model="gates.frequencyMax" />
                        </div>
                    </div>
                </div>


                <div id="map" class="map-container vbox-main tab-pane" v-show="selectedTab === 3"></div>
                
                <div class="vbox-main tab-pane sensor-table" v-show="selectedTab === 4">
                    <table class="table">
                        <thead>    
                            <tr>
                                <th scope="col">
                                    <div class="dropdown">
                                        <button
                                            class="btn btn-outline-primary dropdown-toggle"
                                            type="button"
                                            id="stationChannelDropdown"
                                            data-bs-toggle="dropdown"
                                            
                                        >
                                            {{ selectedOption }}
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="stationChannelDropdown">
                                            <li><a class="dropdown-item" href="#" @click="setOption('Station')">Station</a></li>
                                            <li><a class="dropdown-item" href="#" @click="setOption('Channel')">Channel</a></li>
                                            <li><a class="dropdown-item" href="#" @click="setOption('Sensor')">Sensor</a></li>
                                            <li><a class="dropdown-item" href="#" @click="setOption('Response')">Response</a></li>
                                        </ul>
                                    </div>
                                </th>
                                
                                <!--<th scope="col" @click="sortTable('sensor')">Station/Channel/Sensor/Response <span v-if="currentSort === 'sensor'"
                                    {{ currentSortDir === 'asc' ? '▲' : '▼' }}
                                </span></th> -->
                                <th scope="col" @click="sortTable('lat')" style="text-align: right">Latitude     <span v-if="currentSort === 'lat'">
                                    {{ currentSortDir === 'asc' ? '▲' : '▼' }}
                                </span></th>
                                <th scope="col" @click="sortTable('lon')" style="text-align: right">Longitude     <span v-if="currentSort === 'lon'">
                                    {{ currentSortDir === 'asc' ? '▲' : '▼' }}
                                </span></th>
                                <th scope="col" @click="sortTable('tmin')" style="text-align: right">Start<span v-if="currentSort === 'tmin'">
                                    {{ currentSortDir === 'asc' ? '▲' : '▼' }}
                                </span></th>
                                <th scope="col" @click="sortTable('tmin')" style="text-align: right">End<span v-if="currentSort === 'tmin'">
                                    {{ currentSortDir === 'asc' ? '▲' : '▼' }}
                                </span></th>
                                <th scope="col" @click="sortTable('deltat')" style="text-align: right">ΔT [Hz]<span v-if="currentSort === 'deltat'">
                                    {{ currentSortDir === 'asc' ? '▲' : '▼' }}
                                </span></th>
                                <th scope="col" @click="sortTable('flag')">Flag<span v-if="currentSort === 'flag'">
                                    {{ currentSortDir === 'asc' ? '▲' : '▼' }}
                                </span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="sensor in sortedSensors">
                                <tr v-for="channel in sensor.channels">
                                    
                                    <td>
                                        <!--{{sensor.codes}}-->
                                        <template v-if="selectedOption === 'Station'">
                                            {{sensor.codes}}
                                        </template>
                                        <template v-if="selectedOption === 'Channel'">
                                            {{channel.codes}}
                                        </template>
                                        <!--<template v-if="selectedOption === 'Response'">
                                                <p>Sampling rate: {{res.input_sample_rate}} Hz -> {{res.output_sample_rate}} Hz</p>
                                        </template>-->
                                        
                                    </td>
                                    <td style="text-align: right">{{ channel.lat }}</td>
                                    <td style="text-align: right">{{ channel.lon }}</td>
                                    <td style="text-align: right">{{channel.tmin}}</td>
                                    <td style="text-align: right">{{channel.tmax ? channel.tmax : ""}}</td>
                                    <td style="text-align: right">{{1/sensor.deltat}}</td>
                                    <td><span v-if="channel.azimuth !== 0 && channel.azimuth !== 90 || channel.dip !== 0 && channel.dip !== -90" data-bs-toggle="tooltip" :title="`Unusual Orientation: Azimuth ${channel.azimuth}, Dip ${channel.dip}`">&#x2221;</span></td>
                                    <!--<td>{{sensor}}</td>-->
                                </tr>
                        </div>
                            </tbody>
                        </tbody>
                    </table>
                </div>
                
            <div v-if="connection.latestError" class="error-display">
                <pre><code>{{ connection.latestError }}</code></pre>
                <div>
                    <button
                        class="btn btn-primary"
                        @click="connection.latestError = ''"
                    >
                        Clear
                    </button>
                </div>
            </div>

            <div class="connection-monitor">
                <div v-if="connection.connected">
                    <footer>
                        Version: {{ connection.serverInfo.pyrocko_version }} |
                        Connected: {{ fmtDuration(connection.connected.duration) }} | 
                    Requests:
                        {{
                            connection.serverInfo
                                ? connection.serverInfo.n_requests
                                : ''
                        }}
                    <span v-if="connection.connected.delay > 2.0">
                        | Delay: {{ fmtDuration(connection.connected.delay) }}
                    </span>
                    </footer>
                </div>
                <div v-else>Disconnected</div>
            </div>
        </div>
    </body>

    <script type="module">
        import { createApp, ref, onMounted, computed } from './js/vue.esm-browser.js'

        import { squirrelMap } from './js/squirrel/map.js'
        import { squirrelTimeline } from './js/squirrel/timeline.js'
        import { squirrelConnection } from './js/squirrel/connection.js'
        import { squirrelGates } from './js/squirrel/gate.js'
        import { fmtDuration } from './js/squirrel/common.js'

        createApp({
            setup() {
                const selectedTab = ref(3)
                const sensors = ref([])
                const response = ref([])
                const currentSort = ref('codes')
                const currentSortDir = ref('asc')

                const selectedOption = ref('Station');
                
                

                let connection = ref(squirrelConnection())
                let gates = squirrelGates()
                let timeline = squirrelTimeline(gates)
                let map = squirrelMap()
                

                gates.addGate()

                const fetchSensors = async () => {
                    const connection = squirrelConnection()
                    sensors.value = await connection.request('raw/get_sensors')
                }

                const fetchResponse = async () => {
                    const connection = squirrelConnection();
                    response.value = await connection.request('raw/get_responses', { kind: 'response' });
                };

                onMounted(() => {
                    fetchSensors()
                    fetchResponse()
                    d3.select('#map').call(map)
                    map.addBasemap().addSensors()
                    d3.select('#timeline').call(timeline)
                    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                    tooltipTriggerList.forEach((tooltipTriggerEl) => {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                    })
                })

                const selectTab = (tabIndex) => {
                    selectedTab.value = tabIndex
                }

                const sortTable = (sortValue) => {
                    if (sortValue === currentSort.value) {
                        currentSortDir.value = currentSortDir.value==='asc'?'desc' : 'asc'
                    } else {
                        currentSort.value = sortValue
                        currentSortDir.value = 'asc'
                    }
                }

                const sortedSensors = computed(() => {
                    return [...sensors.value].sort((a,b) => {
                        let modifier = 1
                        if (currentSortDir.value === 'desc') modifier = -1
                        
                        if (a[currentSort.value] < b[currentSort.value]) return -1 * modifier;
                        if (a[currentSort.value] > b[currentSort.value]) return 1 * modifier;
                        return 0;
                        });
                    });

                    const currentDate = new Date()

                    const year = currentDate.getFullYear()
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0')
                    const day = String(currentDate.getDate()).padStart(2, '0')
                    const hours = String(currentDate.getHours()).padStart(2, '0')
                    const minutes = String(currentDate.getMinutes()).padStart(2, '0')
                    const seconds = String(currentDate.getSeconds()).padStart(2, '0')

                    const presentDate = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`

                     

                    const setOption = (option) => {
                        console.log('Selected:', option);
                        selectedOption.value = option;
                    };


                return { connection, selectedTab, selectTab, sensors, response, gates: ref(gates), fmtDuration, currentSort, currentSortDir, sortedSensors, sortTable, presentDate, selectedOption, setOption}
            },
        }).mount('#app')
    </script>
</html>
