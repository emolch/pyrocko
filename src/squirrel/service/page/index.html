<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>Squirrel</title>
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="images/apple-touch-icon.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="images/favicon-32x32.png"
        />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="images/favicon-16x16.png"
        />
        <link rel="manifest" href="site.webmanifest" />

        <link href="css/bootstrap.min.css" rel="stylesheet" />
        <link href="css/local.css" rel="stylesheet" />
        <script src="js/d3.v7.min.js"></script>
    </head>

    <body>
        <div id="app" class="vbox-container">
            <div v-if="!connection.connected" class="curtain">DISCONNECTED</div>
            <div v-if="connection.connected && connection.connected.delay > 5.0" class="curtain">DELAY {{ fmtDuration(connection.connected.delay) }}</div>

            <!--<div id="map" class="map-container"></div>-->
            <div id="timeline" tabindex="0" class="vbox-main"></div>
            <div>
                <div class="form-group row">
                    <div class="col-2">
                        <input type="text" class="form-control" v-model="gates.frequencyMin" />
                    </div>
                    <div class="col-2">
                        <input type="text" class="form-control" v-model="gates.frequencyMax" />
                    </div>
                </div>
            </div>

            <div v-if="connection.latestError" class="error-display">
                <pre><code>{{ connection.latestError }}</code></pre>
                <div>
                    <button
                        class="btn btn-primary"
                        @click="connection.latestError = ''"
                    >
                        Clear
                    </button>
                </div>
            </div>

            <div class="connection-monitor">
                <div v-if="connection.connected">
                    Version: {{ connection.serverInfo.pyrocko_version }} |
                    Connected: {{ fmtDuration(connection.connected.duration) }} | 
                    Requests:
                    {{
                        connection.serverInfo
                            ? connection.serverInfo.n_requests
                            : ''
                    }}
                    <span v-if="connection.connected.delay > 2.0">
                        | Delay: {{ fmtDuration(connection.connected.delay) }}
                    </span>
                </div>
                <div v-else>Disconnected</div>
            </div>
        </div>
    </body>

    <script type="module">
        import { createApp, ref, onMounted } from './js/vue.esm-browser.js'

        import { squirrelMap } from './js/squirrel/map.js'
        import { squirrelTimeline } from './js/squirrel/timeline.js'
        import { squirrelConnection } from './js/squirrel/connection.js'
        import { squirrelGates } from './js/squirrel/gate.js'
        import { fmtDuration } from './js/squirrel/common.js'

        createApp({
            setup() {
                const sensors = ref([])

                let connection = ref(squirrelConnection())
                let gates = squirrelGates()
                let timeline = squirrelTimeline(gates)
                let map = squirrelMap()

                gates.addGate()

                const fetchSensors = async () => {
                    const connection = squirrelConnection()
                    sensors.value = await connection.request('raw/get_sensors')
                }

                onMounted(() => {
                    //fetchSensors()
                    //d3.select('#map').call(map)
                    //map.addBasemap().addSensors()
                    d3.select('#timeline').call(timeline)
                })

                return { connection, sensors, gates: ref(gates), fmtDuration }
            },
        }).mount('#app')
    </script>
</html>
